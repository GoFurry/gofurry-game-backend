# ===============================
# 基础配置
# ===============================
SecRuleEngine On
# SecRuleEngine DetectionOnly
SecRequestBodyAccess On
SecResponseBodyAccess Off

SecRequestBodyLimit 10485760
SecRequestBodyNoFilesLimit 1048576

SecDebugLogLevel 3
SecDebugLog logs/debug.log
SecAuditEngine On
# SecAuditEngine RelevantOnly
SecAuditLog logs/coraza.log
SecAuditLogParts ABIJDEFHZ

# ===============================
# 官方推荐规则
# ===============================

# 按 JSON 结构解析 body
# 测试(放行) curl -X POST ^
#  -H "Content-Type: application/json" ^
#  -d "{\"id\":1}" ^
#  "http://192.168.153.1:9998/api/game/panel/main"
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
"id:210001,phase:1,pass,nolog,ctl:requestBodyProcessor=JSON"

# 请求体解析失败拦截
# 测试(拦截) curl -X POST ^
#  -H "Content-Type: application/json" ^
#  -d "{\"id\":1}" ^
#  "http://192.168.153.1:9998/api/game/panel/main"
SecRule REQBODY_ERROR "!@eq 0" \
"id:210002,phase:2,log,deny,status:400,msg:'Failed to parse request body',severity:2"

# 参数数量限制
# 测试(拦截) curl "http://192.168.153.1:9998/api/game/panel/main?a=1&b=1&c=1&d=1&e=1&f=1&g=1&h=1&i=1&j=1&k=1&l=1&m=1&n=1&o=1&p=1&q=1&r=1&s=1&t=1&u=1"
SecRule &ARGS "@gt 20" \
"id:210003,phase:2,deny,status:403,msg:'Too many parameters'"

# 异常 URI 长度 未生效
SecRule REQUEST_URI "@gt 100" \
"id:210004,phase:1,deny,status:414,msg:'Request URI too long'"

# ===============================
# 基础防护规则
# ===============================

# 常见扫描器 UA sqlmap | nikto | acunetix | nessus | masscan | nmap | fuzz | dirbuster | gobuster
# 测试(拦截) curl -A "sqlmap" "http://IP:PORT/path"
# 测试(拦截) curl -A "nmap" "http://IP:PORT/path"
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(sqlmap|nikto|acunetix|nessus|masscan|nmap|fuzz|dirbuster|gobuster)" \
"id:200001,phase:1,deny,status:403,msg:'Scanner or automated tool detected'"

# SQL 注入
# 测试(拦截) curl "http://IP:PORT/path?id=1%20union%20select%201"
SecRule ARGS "@rx (?i)(union\s+select|select.+from|insert\s+into|update.+set|delete\s+from|or\s+1=1|sleep\(|benchmark\()" \
"id:200002,phase:2,deny,status:403,msg:'SQL Injection detected'"

# XSS
# 测试(拦截) curl "http://IP:PORT/path?name=%3Cscript%3Ealert(1)%3C/script%3E"
SecRule ARGS "@rx (?i)(<script|<img|javascript:|onerror=|onload=|alert\()" \
"id:200003,phase:2,deny,status:403,msg:'XSS detected'"

# 命令注入
# 测试(拦截) curl "IP:PORT/path?cmd=ls;whoami"
# 测试(拦截) curl "http://IP:PORT/path?cmd=cmd.exe%20/c%20dir"
SecRule ARGS "@rx (?i)(;|\|\||&&|`|\$\(|\b(cmd|powershell|bash|sh|curl|wget)\b)" \
"id:200004,phase:2,deny,status:403,msg:'Command injection detected'"

# 路径穿越
# 测试 curl "http://IP:PORT/path/%2e%2e/%2e%2e/windows/system32"
SecRule REQUEST_URI|REQUEST_URI_RAW "@rx (\.\./|%2e%2e|%252e%252e)" \
"id:200005,phase:1,deny,status:403,msg:'Path traversal detected'"

# 非法 HTTP 方法
# 测试(拦截) curl -X TRACE "http://IP:PORT/path"
SecRule REQUEST_METHOD "!^(GET|POST|PUT|DELETE|PATCH|OPTIONS)$" \
"id:200006,phase:1,deny,status:405,msg:'Invalid HTTP method'"

# 非法 Content-Type
# 测试(拦截) curl -X POST ^
#  -H "Content-Type: text/plain" ^
#  -d "test" ^
#  "http://IP:PORT/path"
SecRule REQUEST_HEADERS:Content-Type "!@rx (?i)^(application/json|application/x-www-form-urlencoded|multipart/form-data)" \
"id:200007,phase:1,deny,status:415,msg:'Invalid Content-Type'"

# JSON 体中危险关键字
# curl -X POST ^
#  -H "Content-Type: application/json" ^
#  -d "{\"id\":\"1 union select 1\"}" ^
#  "http://IP:PORT/path"
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
"id:200008,phase:2,pass,nolog,chain"
    SecRule REQUEST_BODY "@rx (?i)(union\s+select|<script|;|\|\||&&)" \
    "deny,status:403,msg:'Malicious JSON body detected'"

# ===============================
# 业务专属规则
# ===============================

SecRule REQUEST_URI "^/api/game/" "id:299999,phase:1,pass"
SecRule REQUEST_URI "^/api/recommend/" "id:299998,phase:1,pass"
SecRule REQUEST_URI "^/api/search/" "id:299997,phase:1,pass"
SecRule REQUEST_URI "^/api/review/" "id:299996,phase:1,pass"
